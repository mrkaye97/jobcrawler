{% extends "base.html" %}
{% block content %}

<body>
    <div class="modal fade" id="requestCompanyModal" tabindex="-1" aria-labelledby="requestCompanyModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="requestCompanyModalLabel">Request a New Company</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="/companies/request" method="POST">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="name" class="form-label">Company Name</label>
                            <input type="text" class="form-control" id="name" name="name"
                                placeholder="Enter company name" required>
                        </div>
                        <div class="mb-3">
                            <label for="board_url" class="form-label">Board URL</label>
                            <input type="url" class="form-control" id="board_url" name="board_url"
                                placeholder="Enter board URL" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Submit Request</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="spinner-container" class="spinner-container" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <div class="modal fade" id="addCompanyModal" tabindex="-1" aria-labelledby="addCompanyModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addCompanyModalLabel">Add a New Company</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="add-company-name" class="form-label">Company Name</label>
                        <input type="text" class="form-control" id="add-company-name" placeholder="Enter company name"
                            required>
                    </div>
                    <div class="mb-3">
                        <label for="add-company-board-url" class="form-label">Board URL</label>
                        <input type="text" class="form-control" id="add-company-board-url" placeholder="Board URL"
                            required pattern="https?://.+" title="Please enter a valid URL">
                    </div>
                    <div class="mb-3">
                        <label for="add-company-url-prefix" class="form-label">Job Posting URL Prefix</label>
                        <input type="text" class="form-control" id="add-company-url-prefix"
                            placeholder="Job Posting URL Prefix" required pattern="https?://.+"
                            title="Please enter a valid URL">
                    </div>
                    <div class="mb-3">
                        <label for="add-company-scraping-method" class="form-label">Scraping Method</label>
                        <select class="form-select" id="add-company-scraping-method" required>
                            <option value="soup">Soup</option>
                            <option value="selenium">Selenium</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-warning" id="test-scraping">Test</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="testResultsModal" tabindex="-1" aria-labelledby="testResultsModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="testResultsModalLabel">Test Results</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <table class="table" id="url-results-table">
                        <thead>
                            <tr>
                                <th scope="col">URLs</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="go-back">Go Back</button>
                    <button type="button" class="btn btn-primary" id="confirm-add-company">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <h1>Companies</h1>
    <table id="company-table" class="table table-striped">
        <thead>
            <tr>
                <th>Name</th>
                <th>Board URL</th>
                <th>Job Posting URL Prefix</th>
                <th>Scraping Method</th>
                {% if current_user.email == "mrkaye97@gmail.com" %}
                <th>Actions</th>
                {% endif %}
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    {% if current_user.email == "mrkaye97@gmail.com" %}
    <button id="add-company-btn" class="btn btn-success">Add Company</button>
    {% endif %}

    <button type="button" class="btn btn-primary" onclick="handleRequestNewCompany()" id="request-new-company-btn">
        Request a new company
    </button>

    <script>
        function handleRequestNewCompany() {
            {% if current_user.is_authenticated %}
            var myModal = new bootstrap.Modal(document.getElementById('requestCompanyModal'), {});
            myModal.show();
            {% else %}
            window.location.href = "{{ url_for('signup') }}?redirect=requestCompany";
            {% endif %}
        }
    </script>


    {% if current_user.is_authenticated %}
    <h1>My Job Searches</h1>
    <table id="board-table" class="table table-striped">
        <thead>
            <tr>
                <th>Company Name</th>
                <th>Search Text (Supports regex)</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <button id="add-row-btn" class="btn btn-success">Add Row</button>
    {% endif %}

    <script>
        let companies = [];
        let firstCompanyId = null;

        document.addEventListener('DOMContentLoaded', function () {
            fetch(`/companies`)
                .then(response => response.json())
                .then(fetchedCompanies => {
                    companies = fetchedCompanies;
                    firstCompanyId = companies.length > 0 ? companies[0].id : null;

                    const companyTableBody = document.querySelector('#company-table tbody');
                    companies.forEach(company => {
                        const row = createCompanyRow(company);
                        companyTableBody.appendChild(row);
                    });

                    $('#company-table').DataTable({
                        pageLength: 5,
                        lengthChange: true,
                        searching: true
                    });

                    fetch(`/searches`)
                        .then(response => response.json())
                        .then(boards => {
                            const tableBody = document.querySelector('#board-table tbody');

                            boards.forEach(board => {
                                const row = createBoardRow(board);
                                tableBody.appendChild(row);
                            });

                            $('#board-table').DataTable({
                                pageLength: 5,
                                lengthChange: true,
                                searching: true
                            });

                        });
                });
        });

        const addCompanyBtn = document.getElementById('add-company-btn');
        addCompanyBtn.addEventListener('click', function () {
            const addCompanyModal = new bootstrap.Modal(document.getElementById('addCompanyModal'), {});
            addCompanyModal.show();
        });

        const confirmAddCompanyBtn = document.getElementById('confirm-add-company');
        confirmAddCompanyBtn.addEventListener('click', function () {
            const nameInput = document.getElementById('add-company-name');
            const boardUrlInput = document.getElementById('add-company-board-url');
            const urlPrefixInput = document.getElementById('add-company-url-prefix');
            const scrapingMethodInput = document.getElementById('add-company-scraping-method');

            fetch(`/companies`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: nameInput.value,
                    board_url: boardUrlInput.value,
                    job_posting_url_prefix: urlPrefixInput.value,
                    scraping_method: scrapingMethodInput.value
                })
            }).then(response => response.json())
                .then(company => {
                    const companyTable = document.getElementById('company-table');
                    const companyRow = createCompanyRow(company);
                    companyTable.querySelector('tbody').appendChild(companyRow);

                    nameInput.value = '';
                    boardUrlInput.value = '';
                    urlPrefixInput.value = '';
                    scrapingMethodInput.value = '';

                    const testResultsModal = bootstrap.Modal.getInstance(document.getElementById('testResultsModal'));
                    testResultsModal.hide();
                });
        });




        function createCompanyRow(company) {
            const row = document.createElement('tr');
            row.dataset.id = company.id;

            const nameCell = document.createElement('td');
            const boardUrlCell = document.createElement('td');
            const jobPostingUrlCell = document.createElement('td');


            const scrapingMethodCell = document.createElement('td');
            let scrapingMethodSelect;

            if ("{{ current_user.email }}" === "mrkaye97@gmail.com") {
                scrapingMethodSelect = document.createElement('select');
                const soupOption = document.createElement('option');
                const seleniumOption = document.createElement('option');

                soupOption.value = 'soup';
                soupOption.text = 'Soup';
                seleniumOption.value = 'selenium';
                seleniumOption.text = 'Selenium';

                scrapingMethodSelect.appendChild(soupOption);
                scrapingMethodSelect.appendChild(seleniumOption);
                scrapingMethodSelect.value = company.scraping_method;

                scrapingMethodCell.appendChild(scrapingMethodSelect);
            } else {
                const scrapingMethodText = document.createElement('span');
                scrapingMethodText.innerText = company.scraping_method === 'soup' ? 'Soup' : 'Selenium';
                scrapingMethodCell.appendChild(scrapingMethodText);
            }

            if ("{{ current_user.email }}" === "mrkaye97@gmail.com") {
                nameCell.contentEditable = true;
                boardUrlCell.contentEditable = true;
                jobPostingUrlCell.contentEditable = true;
            }

            jobPostingUrlCell.innerText = company.job_posting_url_prefix || '';
            nameCell.innerText = company.name;
            boardUrlCell.innerText = company.board_url;

            row.appendChild(nameCell);
            row.appendChild(boardUrlCell);
            row.appendChild(jobPostingUrlCell);
            row.appendChild(scrapingMethodCell);

            if ("{{ current_user.email }}" === "mrkaye97@gmail.com") {
                const actionsCell = document.createElement('td');
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger';

                deleteBtn.innerText = 'Delete';
                deleteBtn.addEventListener('click', function () {
                    fetch(`/companies/${row.dataset.id}`, {
                        method: 'DELETE'
                    }).then(() => {
                        row.remove();
                    });
                });

                actionsCell.appendChild(deleteBtn);
                row.appendChild(actionsCell);

                nameCell.addEventListener('blur', autoSaveCompany);
                nameCell.addEventListener('keydown', handleEnterKey(autoSaveCompany));
                boardUrlCell.addEventListener('blur', autoSaveCompany);
                boardUrlCell.addEventListener('keydown', handleEnterKey(autoSaveCompany));
                jobPostingUrlCell.addEventListener('blur', autoSaveCompany);
                jobPostingUrlCell.addEventListener('keydown', handleEnterKey(autoSaveCompany));

                if (scrapingMethodSelect) {
                    scrapingMethodSelect.addEventListener('change', autoSaveCompany);
                }
            }

            return row;
        }

        function autoSaveCompany(event) {
            const cell = event.target;
            const row = cell.closest('tr');
            const nameCell = row.querySelector('td:nth-child(1)');
            const boardUrlCell = row.querySelector('td:nth-child(2)');
            const jobPostingUrlCell = row.querySelector('td:nth-child(3)');
            const scrapingMethodSelect = row.querySelector('td:nth-child(4) select');

            const formData = new FormData();

            console.log("Name: ", nameCell);
            console.log("boardUrlCell: ", boardUrlCell);
            console.log("jobPostingUrlCell: ", jobPostingUrlCell);
            console.log("scrapingMethodSelect: ", scrapingMethodSelect);

            formData.append('name', nameCell.innerText);
            formData.append('board_url', boardUrlCell.innerText);
            formData.append('job_posting_url_prefix', jobPostingUrlCell.innerText);
            formData.append('scraping_method', scrapingMethodSelect.value);

            fetch(`/companies/${row.dataset.id}`, {
                method: 'PUT',
                body: formData
            });
        }

        const addRowBtn = document.getElementById('add-row-btn');
        addRowBtn.addEventListener('click', function () {
            const defaultCompanyId = firstCompanyId;

            fetch(`/users/current/default-search`)
                .then(response => response.json())
                .then(fields => {
                    const defaultSearchRegex = fields.default_search;

                    let board = {
                        company_id: defaultCompanyId,
                        search_regex: defaultSearchRegex
                    };

                    const tableBody = document.querySelector('#board-table tbody');
                    const row = createBoardRow(board);
                    tableBody.appendChild(row);

                    fetch(`/searches`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(board)
                    }).then((response) => {
                        response.json().then(newBoard => {
                            row.dataset.id = newBoard.id;
                        });
                    });
                });
        });

        function createBoardRow(board) {
            const row = document.createElement('tr');
            row.dataset.id = board.search_id;

            const companyNameCell = document.createElement('td');
            const companySelect = document.createElement('select');
            const searchCell = document.createElement('td');

            companies.forEach(company => {
                const option = document.createElement('option');
                option.value = company.id;
                option.text = company.name;

                if (company.id === board.company_id) {
                    option.selected = true;
                }
                companySelect.appendChild(option);
            });

            companyNameCell.appendChild(companySelect);

            searchCell.contentEditable = true;

            searchCell.innerText = board.search_regex;

            row.appendChild(companyNameCell);
            row.appendChild(searchCell);

            const actionsCell = document.createElement('td');
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn btn-danger';

            deleteBtn.innerText = 'Delete';
            deleteBtn.addEventListener('click', function () {
                fetch(`/searches/${row.dataset.id}`, {
                    method: 'DELETE'
                }).then(() => {
                    row.remove();
                });
            });

            actionsCell.appendChild(deleteBtn);
            row.appendChild(actionsCell);

            companySelect.addEventListener('change', autoSaveBoard);
            searchCell.addEventListener('blur', autoSaveBoard);
            searchCell.addEventListener('keydown', handleEnterKey(autoSaveBoard));

            return row;
        }

        function autoSaveBoard(event) {
            const cell = event.target;
            const row = cell.closest('tr');
            const companySelect = row.querySelector('td:nth-child(1) select');
            const searchCell = row.querySelector('td:nth-child(2)');

            const formData = new FormData();
            formData.append('company_id', companySelect.value);
            formData.append('search_regex', searchCell.innerText);

            fetch(`/searches/${row.dataset.id}`, {
                method: 'PUT',
                body: formData
            });
        }

        function handleEnterKey(saveFunction) {
            return function (event) {
                if (event.key === 'Enter') {
                    event.preventDefault(); // Prevent adding a newline
                    event.target.blur(); // Remove focus from the cell
                }
            };
        }

        const testScrapingBtn = document.getElementById('test-scraping');
        testScrapingBtn.addEventListener('click', function () {
            const nameInput = document.getElementById('add-company-name');
            const boardUrlInput = document.getElementById('add-company-board-url');
            const jobPostingUrlPrefixInput = document.getElementById('add-company-url-prefix');
            const scrapingMethodInput = document.getElementById('add-company-scraping-method');

            const spinnerContainer = document.getElementById('spinner-container');
            spinnerContainer.style.display = 'flex';

            fetch(`/scraping/test`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: nameInput.value,
                    board_url: boardUrlInput.value,
                    job_posting_url_prefix: jobPostingUrlPrefixInput.value,
                    scraping_method: scrapingMethodInput.value
                })
            }).then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            }).then(urlResults => {
                spinnerContainer.style.display = 'none';

                const urlResultsTableBody = document.getElementById('url-results-table').getElementsByTagName('tbody')[0];
                urlResultsTableBody.innerHTML = '';
                urlResults.forEach(url => {
                    const tr = document.createElement('tr');
                    const td = document.createElement('td');

                    const anchor = document.createElement('a');
                    anchor.href = url.href;
                    anchor.textContent = url.text;
                    td.appendChild(anchor);

                    tr.appendChild(td);
                    urlResultsTableBody.appendChild(tr);
                });

                const addCompanyModal = bootstrap.Modal.getInstance(document.getElementById('addCompanyModal'));
                addCompanyModal.hide();

                const testResultsModal = new bootstrap.Modal(document.getElementById('testResultsModal'), {});
                testResultsModal.show();
            }).catch(error => {
                spinnerContainer.style.display = 'none';

                const addCompanyModal = document.getElementById('addCompanyModal');
                const errorContainer = document.createElement('div');
                errorContainer.className = 'alert alert-danger mt-2';
                errorContainer.textContent = 'Something went wrong. Please check your inputs and try again.';

                // Remove existing error message if present
                const existingError = addCompanyModal.querySelector('.alert');
                if (existingError) {
                    existingError.remove();
                }

                addCompanyModal.querySelector('.modal-body').appendChild(errorContainer);
            });
        });

        const goBackBtn = document.getElementById('go-back');
        goBackBtn.addEventListener('click', function () {
            const testResultsModal = bootstrap.Modal.getInstance(document.getElementById('testResultsModal'));
            testResultsModal.hide();

            const addCompanyModal = new bootstrap.Modal(document.getElementById('addCompanyModal'), {});
            addCompanyModal.show();
        });

    </script>
</body>

{% endblock %}